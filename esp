
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local lpr = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Fungsi utama ESP
local function ApplyESP(plr)
    local highlight = Instance.new("Highlight")
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.FillTransparency = 0.5
    
    local nameTag = Drawing.new("Text")
    local toolTag = Drawing.new("Text")
    local healthTag = Drawing.new("Text")

    local conn
    conn = RunService.RenderStepped:Connect(function()
        -- Mengambil settings dari getgenv (yang dikirim dari UI)
        local Settings = getgenv().VisualSettings
        if not Settings then return end -- Guard jika UI belum siap

        if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr ~= lpr then
            local char, hum = plr.Character, plr.Character:FindFirstChild("Humanoid")
            local head = char:FindFirstChild("Head")
            local _, onScreen = camera:WorldToViewportPoint(char.HumanoidRootPart.Position)

            -- Box Highlights
            highlight.Adornee = char
            highlight.Parent = char
            highlight.FillColor = Settings.Color
            highlight.Enabled = Settings.Highlights

            if onScreen and head then
                local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.7, 0))
                
                -- Name Tag
                nameTag.Visible = Settings.Names
                if nameTag.Visible then
                    nameTag.Text = plr.DisplayName
                    nameTag.Position = Vector2.new(headPos.X, headPos.Y - 20)
                    nameTag.Size = 13; nameTag.Center = true; nameTag.Outline = true; nameTag.Color = Color3.new(1,1,1)
                end

                -- Health Tag
                healthTag.Visible = Settings.HealthPercent
                if healthTag.Visible and hum then
                    local hp = math.floor(hum.Health)
                    healthTag.Text = "[" .. hp .. "%]"
                    healthTag.Position = Vector2.new(headPos.X, headPos.Y - 35)
                    healthTag.Size = 12; healthTag.Center = true; healthTag.Outline = true
                    healthTag.Color = Color3.fromRGB(255, 0, 0):Lerp(Color3.fromRGB(0, 255, 0), hp/hum.MaxHealth)
                end

                -- Tool Tag
                toolTag.Visible = Settings.Tools
                if toolTag.Visible then
                    local tool = char:FindFirstChildOfClass("Tool")
                    toolTag.Text = tool and "[" .. tool.Name .. "]" or "[None]"
                    toolTag.Position = Vector2.new(headPos.X, headPos.Y - 5)
                    toolTag.Size = 12; toolTag.Center = true; toolTag.Outline = true; toolTag.Color = Color3.new(1,1,0)
                end
            else
                nameTag.Visible = false; toolTag.Visible = false; healthTag.Visible = false
            end
        else
            highlight.Enabled = false; nameTag.Visible = false; toolTag.Visible = false; healthTag.Visible = false
        end

        -- Cleanup jika player keluar
        if not plr.Parent then
            highlight:Destroy()
            nameTag:Remove()
            toolTag:Remove()
            healthTag:Remove()
            conn:Disconnect()
        end
    end)
end

-- Inisialisasi untuk player yang sudah ada
for _, p in ipairs(Players:GetPlayers()) do
    if p ~= lpr then ApplyESP(p) end
end

-- Inisialisasi untuk player yang baru masuk
Players.PlayerAdded:Connect(function(p)
    if p ~= lpr then ApplyESP(p) end
end)
