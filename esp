local function ApplyESP(plr)
    local highlight = Instance.new("Highlight")
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.FillTransparency = 0.5
    local nameTag = Drawing.new("Text")
    local toolTag = Drawing.new("Text")
    local healthTag = Drawing.new("Text")

    local conn
    conn = RunService.RenderStepped:Connect(function()
        if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr ~= lpr then
            local char, hum = plr.Character, plr.Character:FindFirstChild("Humanoid")
            local head = char:FindFirstChild("Head")
            local _, onScreen = camera:WorldToViewportPoint(char.HumanoidRootPart.Position)

            highlight.Adornee = char; highlight.Parent = char
            highlight.FillColor = VisualSettings.Color; highlight.Enabled = VisualSettings.Highlights

            if onScreen and head then
                local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.7, 0))
                
                nameTag.Visible = VisualSettings.Names
                if nameTag.Visible then
                    nameTag.Text = plr.DisplayName
                    nameTag.Position = Vector2.new(headPos.X, headPos.Y - 20)
                    nameTag.Size = 13; nameTag.Center = true; nameTag.Outline = true; nameTag.Color = Color3.new(1,1,1)
                end

                healthTag.Visible = VisualSettings.HealthPercent
                if healthTag.Visible and hum then
                    local hp = math.floor(hum.Health)
                    healthTag.Text = "[" .. hp .. "%]"
                    healthTag.Position = Vector2.new(headPos.X, headPos.Y - 35)
                    healthTag.Size = 12; healthTag.Center = true; healthTag.Outline = true
                    healthTag.Color = Color3.fromRGB(255, 0, 0):Lerp(Color3.fromRGB(0, 255, 0), hp/hum.MaxHealth)
                end

                toolTag.Visible = VisualSettings.Tools
                if toolTag.Visible then
                    local tool = char:FindFirstChildOfClass("Tool")
                    toolTag.Text = tool and "[" .. tool.Name .. "]" or "[None]"
                    toolTag.Position = Vector2.new(headPos.X, headPos.Y - 5)
                    toolTag.Size = 12; toolTag.Center = true; toolTag.Outline = true; toolTag.Color = Color3.new(1,1,0)
                end
            else
                nameTag.Visible = false; toolTag.Visible = false; healthTag.Visible = false
            end
        else
            highlight.Enabled = false; nameTag.Visible = false; toolTag.Visible = false; healthTag.Visible = false
        end
        if not plr.Parent then
            highlight:Destroy(); nameTag:Remove(); toolTag:Remove(); healthTag:Remove(); conn:Disconnect()
        end
    end)
end

-- Init
for _, p in ipairs(Players:GetPlayers()) do if p ~= lpr then ApplyESP(p) end end
Players.PlayerAdded:Connect(ApplyESP)
Players.PlayerAdded:Connect(function() PlayerDropdown:SetOptions(getDisplayNames()) end)
Players.PlayerRemoving:Connect(function() PlayerDropdown:SetOptions(getDisplayNames()) end)
